---
title: スイッチに対応するAPI、ついつい冪等性を忘れてちゃう問題
tags:
  - API
  - REST-API
  - 冪等性
private: false
updated_at: '2022-04-19T12:17:18+09:00'
id: 60403dd55d6573442dfc
organization_url_name: null
slide: false
ignorePublish: false
---
下記スイッチの画像をご覧ください。

![スクリーンショット 2021-08-27 17.32.12.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/83424/ac88736e-c5ee-d885-5573-90d94e65968f.png)

上段のスイッチはOFF、下段はONです。
OFFのスイッチをクリックするとONに変更、ONのスイッチをクリックするとOFFに変更されます。

スイッチをクリックした際にスイッチの状態を反転させるAPIを実装します。
テーブルスキーマは下記の通り。スイッチごとにIDを持っており、ONの場合はenabled=1、OFFの場合はenabled=0とします。

```console
switches
+--------------------------+-------------------+------+-----+---------+----------------+
| Field                    | Type              | Null | Key | Default | Extra          |
+--------------------------+-------------------+------+-----+---------+----------------+
| id                       | bigint            | NO   | PRI | NULL    | auto_increment |
| enabled                  | tinyint(1)        | NO   |     | 0       |                |
+--------------------------+-------------------+------+-----+---------+----------------+
```

このような仕様の場合、どのようなAPIを実装しますか？

# パターン１ トグル

パターンの1つとしてトグルのように振る舞うAPIが考えられます。

```
PUT /toggle_switch/:id
```

toggle_switchという名前の通り、指定したidのenabledを反転させます。
スイッチなので、現状がONならOFF、OFFならONにすれば良いのです。ONからONやOFFからOFFという操作はありません。
この仕様を考慮するとこの実装で問題なさそうですが、利用者が混乱する挙動をすることがあります。

それが下記のパターンです。
APIへのリクエストはネットワークの不調などを考慮してレスポンスがない場合に再送するようにしていることがあります。
下記では1回目のリクエストがタイムアウトしたためリクエストを再送していますが、サーバーでは両方のリクエストが正常に処理されるため、スイッチがOFF→ON→OFFと更新されてOFFになってしまっています。

![スクリーンショット 2021-08-31 10.51.17.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/83424/88719106-3482-f90c-a173-b1031305ed9e.png)

システム的にはデータと画面描画が一致しており問題はないのですが、利用者としてはONにしたつもりなのにOFFのままなのでユーザービリティが良くないですよね。

この事象はこのAPIが冪等性がないために発生しています。
冪等性を持ったAPIの場合はどうなるかパターン2でみてみましょう。

# パターン２　更新後のON/OFFを明示的に指定する

パターン2では冪等性を持たせたAPIを考えます。
下記はONとOFFでエンドポイントを分けています。呼び出すエンドポイントによってONになるのかOFFになるのか明確であり、何度呼び出しても同じ結果になるので冪等性を持っています。

```
PUT /switch_on/:id
PUT /switch_off/:id
```

または、エンドポイントは1つで、パラメーターで変更後のON/OFFを指定するパターンも考えられます。
こちらも指定するパラメーターによってONになるのかOFFになるのか明確であり、冪等性を持っています。

```
PUT /switch/:id
params
  enable: boolean
```

今回のAPIの場合、パターン１の例と同じタイムアウト＆再送した場合は下記のように動作します。

![スクリーンショット 2021-08-31 11.18.45.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/83424/7af6d1d4-f717-9c1a-de92-c7ec18a0cb63.png)

パターン1とは異なり、最終的にONになります。
こちらの場合、利用者が混乱することもなく、システム的にも問題ありません。

# まとめ

APIは冪等性がある方が良いとよく言われているものの、スイッチなどの場合ついついパターン1で実装してしまうこともあると思います。
しかし、パターン２のように冪等性のあるAPIで実装した方が適切な挙動をしてくれることが多いので、APIを実装する前に一呼吸おいて冪等性を忘れず考慮するようにしましょう。
